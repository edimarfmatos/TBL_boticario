<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Leitor de Remessa OCR</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 0; }
    video { width: 100%; max-width: 400px; margin-top: 20px; }
    #status { margin-top: 20px; font-size: 20px; color: green; }
    #overlay {
      position: absolute;
      top: 50%; left: 50%;
      width: 200px; height: 50px;
      margin-left: -100px; margin-top: -25px;
      border: 2px solid red;
      pointer-events: none;
    }
    #container { position: relative; display: inline-block; }
    #btnNext, #btnBack {
      margin-top: 20px; font-size: 18px; padding: 10px 20px; display: none;
    }
  </style>
</head>
<body>
  <h1>Leitor de Remessa OCR</h1>
  <div id="container">
    <video id="video" autoplay></video>
    <div id="overlay"></div>
  </div>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="status">Aponte o código da remessa dentro do retângulo vermelho</div>
  <button id="btnNext">Próximo Volume</button>
  <button id="btnBack">Voltar para câmera</button>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const status = document.getElementById('status');
  const btnNext = document.getElementById('btnNext');
  const btnBack = document.getElementById('btnBack');

  let scanning = true;
  let lastRemessa = "";
  let lastScanAt = 0;
  const SCAN_COOLDOWN = 800; // ms

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      video.srcObject = stream;
    } catch (err) {
      status.innerHTML = "Não foi possível acessar a câmera: " + err;
    }
  }
  startCamera();

  async function scanFrame() {
    if (!scanning || video.readyState !== video.HAVE_ENOUGH_DATA) {
      if (scanning) setTimeout(scanFrame, 250);
      return;
    }

    const ctx = canvas.getContext('2d');
    const w = 200, h = 50;
    canvas.width = w; canvas.height = h;

    const x = (video.videoWidth - w) / 2;
    const y = (video.videoHeight - h) / 2;
    ctx.drawImage(video, x, y, w, h, 0, 0, w, h);

    const imageData = canvas.toDataURL('image/png');

    try {
      const { data: { text } } = await Tesseract.recognize(imageData, 'eng', {
        tessedit_char_whitelist: 'NP:.0123456789'
      });

      const qrTexto = text.toUpperCase();
      const match = qrTexto.match(/\b(NP:|N\.P\.:)\d{1,8}\b/);

      const now = Date.now();

      if (match) {
        const lida = match[0];

        // Debounce (não contar o mesmo frame repetido)
        if (now - lastScanAt < SCAN_COOLDOWN) {
          setTimeout(scanFrame, 250);
          return;
        }

        // Permitir ler a MESMA remessa novamente depois que o usuário clicar "Próximo"
        if (lida === lastRemessa) {
          // se for exatamente a mesma e o usuário não clicou "Próximo", ignora
          setTimeout(scanFrame, 250);
          return;
        }

        lastRemessa = lida;
        lastScanAt = now;
        scanning = false;

        status.innerHTML = "✅ Remessa detectada: " + lastRemessa + "<br>Consultando planilha...";

        const linkWebApp = "https://script.google.com/macros/s/AKfycbxOVNtNR_o8GlrYoOCXwuc3jq9kpMPWqK9f_XbkAY08xiERIaFIPOhu3u6hVABfRCfP9w/exec?remessa=" + encodeURIComponent(lastRemessa);

        fetch(linkWebApp)
          .then(res => res.json())
          .then(data => {
            // feedback tátil (opcional)
            if (navigator.vibrate) navigator.vibrate(60);

            status.innerHTML =
              "<h1 style='font-size:100px; color:red;'>Palete: PL" + data.palete + "</h1>" +
              "<p>" + data.mensagem + "</p>" +
              "<p style='font-size:20px; color:blue;'>Total de leituras dessa remessa: <b>" + data.contagem + "</b></p>";

            btnNext.style.display = "inline-block";
            btnBack.style.display = "inline-block";
          })
          .catch(err => {
            status.innerHTML = "⚠️ Erro ao consultar planilha: " + err;
            btnBack.style.display = "inline-block";
          });
      } else {
        setTimeout(scanFrame, 250);
      }
    } catch (err) {
      console.error(err);
      setTimeout(scanFrame, 250);
    }
  }

  setTimeout(scanFrame, 250);

  // Próximo Volume (permite ler a MESMA remessa em sequência)
  btnNext.addEventListener('click', () => {
    scanning = true;
    lastRemessa = "";          // <-- ESSENCIAL
    status.innerHTML = "Aponte o código da remessa dentro do retângulo vermelho";
    btnNext.style.display = "none";
    btnBack.style.display = "none";
    scanFrame();
  });

  // Voltar
  btnBack.addEventListener('click', () => {
    scanning = true;
    lastRemessa = "";          // <-- também limpa
    status.innerHTML = "Aponte o código da remessa dentro do retângulo vermelho";
    btnNext.style.display = "none";
    btnBack.style.display = "none";
    scanFrame();
  });
</script>

</body>
</html>
